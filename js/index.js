var r=(i,e,t)=>new Promise((n,s)=>{var a=h=>{try{l(t.next(h))}catch(f){s(f)}},o=h=>{try{l(t.throw(h))}catch(f){s(f)}},l=h=>h.done?n(h.value):Promise.resolve(h.value).then(a,o);l((t=t.apply(i,e)).next())});import q from"fs";import ae from"path";import W from"path";var J=i=>{let e=W.parse(i);if(e.name===i)throw new Error(`${i} path could not be parsed`);return e},O=J;import{Mutex as oe}from"async-mutex";var c=class{open(n){return r(this,arguments,function*({name:e,path:t}){throw new Error("Method not implemented.")})}set(e,t){return r(this,null,function*(){throw new Error("Method not implemented.")})}get(e){return r(this,null,function*(){throw new Error("Method not implemented.")})}getAll(){return r(this,null,function*(){throw new Error("Method not implemented.")})}remove(e){return r(this,null,function*(){throw new Error("Method not implemented.")})}delete(){return r(this,null,function*(){throw new Error("Method not implemented.")})}},u=c;var m=class extends u{open(n){return r(this,arguments,function*({name:e,path:t}){})}set(e,t){return r(this,null,function*(){})}get(e){return r(this,null,function*(){})}getAll(){return r(this,null,function*(){})}remove(e){return r(this,null,function*(){})}delete(){return r(this,null,function*(){})}},p=m;var y=class{open(n){return r(this,arguments,function*({name:e,path:t}){})}set(e,t){return r(this,null,function*(){})}get(e){return r(this,null,function*(){})}getAll(){return r(this,null,function*(){})}remove(e){return r(this,null,function*(){})}delete(){return r(this,null,function*(){})}},g=y;import N from"path";import{write_json as w,read_json as C,delete_json as H}from"files-js";var b=class extends u{constructor(){super(),this.json={},this.path=""}open(n){return r(this,arguments,function*({name:e,path:t}){this.path=N.join(t,`${e}.json`),this.json={},C(this.path)?this.json=C(this.path):w(this.json,this.path,{format:!0})})}set(e,t){return r(this,null,function*(){this.json[e]=t,w(this.json,this.path,{format:!0})})}get(e){return r(this,null,function*(){return this.json[e]})}getAll(){return r(this,null,function*(){let e=[];return this.json&&(e=Object.keys(this.json).map(t=>({key:t,value:this.json[t]}))),e})}remove(e){return r(this,null,function*(){delete this.json[e],w(this.json,this.path,{format:!0})})}delete(){return r(this,null,function*(){this.json={},H(this.path)})}},v=b;import d from"path";import{write_json as G,read_json as I,delete_json as $,mkdir as Q,ls_files as L,rm_dir as U}from"files-js";var E=class extends u{constructor(){super(),this.path=""}open(n){return r(this,arguments,function*({name:e,path:t}){t=d.join(t,e),Q(t),this.path=t})}set(e,t){return r(this,null,function*(){if(typeof e=="number"&&(e=this._convet_to_string_int(e)),typeof t!="object")throw new Error("value must be a js object");return G(t,d.join(this.path,e+".json"),{format:!0})})}get(e){return r(this,null,function*(){return typeof e=="number"&&(e=this._convet_to_string_int(e)),I(d.join(this.path,e+".json"))})}getAll(){return r(this,null,function*(){let e=L(this.path),t=[];for(let n of e)t.push({key:d.basename(n,".json"),value:I(d.join(this.path,n))});return t})}remove(e){return r(this,null,function*(){return typeof e=="number"&&(e=this._convet_to_string_int(e)),$(d.join(this.path,e+".json"))})}delete(){return r(this,null,function*(){let e=L(this.path);for(let t=0;t<e.length;t++)$(e[0]);U(this.path)})}_convet_to_string_int(e){let t=10,n=e.toString(),s=n.length;return"0".repeat(t-s)+n}},S=E;import X from"sqlite3";import{open as Y}from"sqlite";import{rm_file as K}from"files-js";var P=class extends u{constructor(){super(),this.file=void 0,this.db=void 0}open(t){return r(this,arguments,function*({name:i,path:e}){this.file=e+"/"+i+".sqlite",this.db=yield Y({filename:this.file,driver:X.Database});try{yield this.db.exec("CREATE TABLE storage ( key TEXT PRIMARY KEY, value TEXT, type TEXT)")}catch(n){if(n.code!=="SQLITE_ERROR")throw n}})}set(i,e){return r(this,null,function*(){let[t,n]=this._parseValue(e),s;try{s=yield this.db.get(`SELECT value FROM storage WHERE key = '${i}'`)}catch(a){if(a.code!=="SQLITE_ERROR")throw a;s=void 0}s?yield this.db.exec(`UPDATE storage SET value = '${t}', type = '${n}' WHERE key = '${i}'`):yield this.db.exec(`INSERT INTO storage (key, value, type) VALUES ( '${i}', '${t}', '${n}')`)})}get(i){return r(this,null,function*(){let e;try{e=yield this.db.get(`SELECT value, type FROM storage WHERE key = '${i}'`)}catch(t){if(t.code!=="SQLITE_ERROR")throw t;e=void 0}if(e&&e.value!=="undefined")return this._parseString(e.value,e.type)})}getAll(){return r(this,null,function*(){let i=yield this.db.all("SELECT key, value, type FROM storage");return i.length===0?[]:i.map(t=>({key:t.key,value:this._parseString(t.value,t.type)}))})}remove(i){return r(this,null,function*(){let e;try{e=yield this.db.get(`SELECT value FROM storage WHERE key = '${i}'`)}catch(t){if(t.code!=="SQLITE_ERROR")throw t;e=void 0}e&&(yield this.db.exec(`DELETE FROM storage WHERE key = '${i}'`))})}delete(){return r(this,null,function*(){yield this.db.exec("DELETE FROM storage"),K(this.file)})}_parseValue(i){if(typeof i=="object")return[JSON.stringify(i),"object"];if(typeof i=="string")return[i,"string"];if(typeof i=="number")return[i.toString(),"number"];if(typeof i=="function")return[i.toString(),"function"];if(typeof i=="boolean")return[i.toString(),"boolean"];if(typeof i=="undefined")return["undefined","undefined"];throw new Error("Invalid value type")}_parseString(value,type){if(type==="object")return JSON.parse(value);if(type==="string")return value;if(type==="number")return Number(value);if(type==="function")return eval(value);if(type==="boolean")return!!value;if(type==="undefined")return}},k=P;import{MongoClient as z}from"mongodb";var x=class extends u{constructor({url:e,database:t}){super(),this.url=e,this.client=new z(e),this.database=t,this.collection=void 0}open(t){return r(this,arguments,function*({name:e}){this.collection=e,yield this.client.connect(),this.database=this.client.db(this.database),this.collection=this.database.collection(this.collection)})}set(e,t){return r(this,null,function*(){return yield this.collection.insertOne(t)})}get(e){return r(this,null,function*(){return yield this.collection.find(e).toArray()})}getAll(){return r(this,null,function*(){return yield this.collection.find({}).toArray()})}remove(e){return r(this,null,function*(){return yield this.collection.deleteMany(e)})}delete(){return r(this,null,function*(){return yield this.collection.drop(),yield this.client.close()})}},_=x;import{MongoClient as re,GridFSBucket as ie}from"mongodb";import{Readable as ne}from"stream";import j from"fs";function Z(i){if(!j.existsSync(i))throw new Error("File not found");if(j.lstatSync(i).isDirectory())throw new Error("Path is a directory");return j.createReadStream(i)}var R=Z;import{Readable as ee}from"stream";function te(i){return new ee({read(){this.push(i),this.push(null)}})}var T=te;import se from"stream-to-array";var M=class extends u{constructor({url:e,database:t}){super(),this.url=e,this.client=new re(e),this.database=t,this.bucket=void 0,this.filesCollection="files",this.chunksCollection="chunks"}open(t){return r(this,arguments,function*({name:e}){let n=e!=null?e:"files";this.filesCollection=n+".files",this.chunksCollection=n+".chunks",yield this.client.connect(),this.database=this.client.db(this.database),this.bucket=new ie(this.database,{bucketName:n})})}set(e,t){return r(this,null,function*(){if(!t.filename)throw new Error("filename is required in metadata");if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");return new Promise((n,s)=>{let a=t.filename,o=this._handleFileInput(e),l=this.bucket.openUploadStream(a,t);l.on("finish",()=>n(!0)),l.on("error",h=>s(h)),o.pipe(l,{end:!0})})})}get(e){return r(this,null,function*(){if(!e.filename)throw new Error("Filename is required in metadata");if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");let t=yield this.bucket.find(e).toArray();return t.length===0?[]:yield Promise.all(t.map(n=>this._get(n)))})}_get(e){return r(this,null,function*(){return yield new Promise((t,n)=>r(this,null,function*(){let s=e._id,a=this.bucket.openDownloadStream(s);a.on("error",l=>n(l));let o=yield se(a).then(function(l){let h=l.map(f=>f instanceof Buffer?f:Buffer.from(f));return Buffer.concat(h)});t({buffer:o,metadata:e})}))})}getAll(){return r(this,null,function*(){if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");return(yield this.bucket.find().toArray()).map(t=>t.filename)})}remove(e){return r(this,null,function*(){if(!e.filename)throw new Error("filename is required in metadata");if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");let t=yield this.bucket.find(e).toArray();return!(t.length===0||(yield Promise.all(t.map(s=>this._remove(s)))).includes(!1))})}_remove(e){return r(this,null,function*(){let t=e._id;return yield this.bucket.delete(t),!0})}close(){return r(this,null,function*(){if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");this.bucket=void 0,yield this.client.close()})}delete(){return r(this,null,function*(){if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");yield this.bucket.drop(),yield this.client.close()})}_handleFileInput(e){if(e instanceof Buffer)return T(e);if(typeof e=="string")return R(e);if(e instanceof ne)return e;throw new Error("Invalid input, expected a Buffer,  ReadableStream, or path to a file.")}},D=M;var A=D;var B=class{constructor({type:e,path:t,keyValue:n,mutex:s,url:a,database:o}){this.type=e,this.path=t,this.keyValue=n!=null?n:!1,this.mutex=s!=null?s:!0,this.url=a!=null?a:"",this.database=o!=null?o:""}open(e){return r(this,null,function*(){let t=new F({type:this.type,path:this.path,keyValue:this.keyValue,mutex:this.mutex,url:this.url,database:this.database});return yield t.open(e),t})}},F=class{constructor({type:e,path:t,keyValue:n,mutex:s,url:a,database:o}){this.add=this.set;this.push=this.set;this.write=this.set;this.read=this.get;this.all=this.getAll;this.list=this.getAll;if(t){let{dir:l,name:h}=O(t);if(h==="file")throw new Error("path must be a directory");this.path=l}else this.path=ae.join(process.cwd(),"storage");if(q.existsSync(this.path)||q.mkdirSync(this.path),this.keyValue=n!=null?n:!1,this.mutex=s===!1?null:new oe,e==="json")this.storage=new S;else if(e==="jsonFile")this.storage=new v;else if(e==="cvs")this.storage=new g;else if(e==="sqlite")this.storage=new k;else if(e==="binary")this.storage=new p;else if(e==="mongodb"){if(!a||!o)throw new Error("url and database must be defined");this.mutex=null,this.keyValue=!1,this.storage=new _({url:a,database:o})}else if(e==="mongoFiles"){if(!a||!o)throw new Error("url and database must be defined");this.mutex=null,this.keyValue=!0,this.storage=new A({url:a,database:o})}else throw new Error(`type ${e} is not supported`);this.index=this.keyValue?-1:0}open(e){return r(this,null,function*(){yield this.storage.open({name:e,path:this.path})})}set(e,t){return r(this,null,function*(){let{key:n,value:s}=this._handleInputs(e,t);return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.set(n,s)}))})}get(e){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.get(e)}))})}getAll(){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.getAll()}))})}has(e){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return!!(yield yield this.storage.get(e))}))})}remove(e){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.remove(e)}))})}delete(){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.delete()}))})}_handleInputs(e,t){let n,s;return this.keyValue?(n=e,s=t):(n=++this.index,s=e),{key:n,value:s}}_mutex(e){return this.mutex?this.mutex.runExclusive(e):e()}},V=B;var vt=V;export{vt as default};
