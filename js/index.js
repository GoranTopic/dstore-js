var w=Object.defineProperty;var X=Object.getOwnPropertyDescriptor;var U=Object.getOwnPropertyNames;var Y=Object.prototype.hasOwnProperty;var y=(t,e)=>()=>(t&&(e=t(t=0)),e);var K=(t,e)=>{for(var r in e)w(t,r,{get:e[r],enumerable:!0})},z=(t,e,r,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let n of U(e))!Y.call(t,n)&&n!==r&&w(t,n,{get:()=>e[n],enumerable:!(i=X(e,n))||i.enumerable});return t};var v=t=>z(w({},"__esModule",{value:!0}),t);var s=(t,e,r)=>new Promise((i,n)=>{var o=c=>{try{u(r.next(c))}catch(g){n(g)}},a=c=>{try{u(r.throw(c))}catch(g){n(g)}},u=c=>c.done?i(c.value):Promise.resolve(c.value).then(o,a);u((r=r.apply(t,e)).next())});import j from"fs";var ee,te,re,C=y(()=>{"use strict";ee=(t,e,r={})=>{var o;let{format:i}=r,n=(o=r.quiet)!=null?o:!0;try{let a=JSON.stringify(t,null,i?4:1);return j.writeFileSync(e,a),!0}catch(a){if(n)return!1;throw a}},te=(t,e={})=>{var i;let r=(i=e.quiet)!=null?i:!0;try{let n=j.readFileSync(t);return JSON.parse(n)}catch(n){if(r)return!1;throw n}},re=(t,e={})=>{var i;let r=(i=e.quiet)!=null?i:!0;try{return j.unlinkSync(t)}catch(n){if(r)return!1;throw n}}});import d from"fs";var se,ie,ne,oe,J=y(()=>{"use strict";se=t=>d.readFileSync(t),ie=t=>d.readFileSync(t).toString("binary"),ne=(t,e)=>{d.writeFileSync(e,t)},oe=(t,e)=>{let r=Buffer.from(t,"binary");d.writeFileSync(e,r)}});import l from"fs";var ae,le,he,ce,ue,me,ye,de,pe,fe,ge,N=y(()=>{"use strict";ae=t=>{try{return l.existsSync(t)}catch(e){return console.error("could not find file "+e),!1}},le=t=>!l.existsSync(t),he=t=>l.readdirSync(t,{withFileTypes:!0}).map(e=>e.name),ce=t=>l.readdirSync(t,{withFileTypes:!0}).filter(e=>e.isDirectory()).map(e=>e.name),ue=t=>l.readdirSync(t,{withFileTypes:!0}).filter(e=>e.isFile()).map(e=>e.name),me=t=>l.mkdir(t,{recursive:!0},e=>{e&&console.error(e)}),ye=(t,e="")=>l.writeFileSync(t,e),de=t=>l.readFileSync(t,{encoding:"utf8"}),pe=(t,e)=>l.renameSync(t,e),fe=t=>l.unlinkSync(t),ge=(t,e={recursive:!0,force:!0})=>l.rmSync(t,e)});var p={};K(p,{delete_json:()=>re,file_exists:()=>ae,file_not_exists:()=>le,ls_dir:()=>he,ls_dirs:()=>ce,ls_files:()=>ue,mkdir:()=>me,mv:()=>pe,read_binary:()=>se,read_binary_to_binstr:()=>ie,read_file:()=>de,read_json:()=>te,rm_dir:()=>ge,rm_file:()=>fe,write_binary:()=>ne,write_binstr:()=>oe,write_file:()=>ye,write_json:()=>ee});var f=y(()=>{"use strict";C();J();N()});import W from"fs";import Fe from"path";import G from"path";var Z=t=>{let e=G.parse(t);if(e.name===t)throw new Error(`${t} path could not be parsed`);return e},I=Z;import{Mutex as Me}from"async-mutex";var b=class{open(i){return s(this,arguments,function*({name:e,path:r}){throw new Error("Method not implemented.")})}set(e,r){return s(this,null,function*(){throw new Error("Method not implemented.")})}get(e){return s(this,null,function*(){throw new Error("Method not implemented.")})}getAll(){return s(this,null,function*(){throw new Error("Method not implemented.")})}remove(e){return s(this,null,function*(){throw new Error("Method not implemented.")})}delete(){return s(this,null,function*(){throw new Error("Method not implemented.")})}},h=b;var _=class extends h{open(i){return s(this,arguments,function*({name:e,path:r}){})}set(e,r){return s(this,null,function*(){})}get(e){return s(this,null,function*(){})}getAll(){return s(this,null,function*(){})}remove(e){return s(this,null,function*(){})}delete(){return s(this,null,function*(){})}},E=_;var S=class{open(i){return s(this,arguments,function*({name:e,path:r}){})}set(e,r){return s(this,null,function*(){})}get(e){return s(this,null,function*(){})}getAll(){return s(this,null,function*(){})}remove(e){return s(this,null,function*(){})}delete(){return s(this,null,function*(){})}},x=S;import be from"path";var we=(f(),v(p)),{write_json:P,read_json:V,delete_json:ve}=we,R=class extends h{constructor(){super(),this.json={},this.path=""}open(i){return s(this,arguments,function*({name:e,path:r}){this.path=be.join(r,`${e}.json`),this.json={},V(this.path)?this.json=V(this.path):P(this.json,this.path,{format:!0})})}set(e,r){return s(this,null,function*(){this.json[e]=r,P(this.json,this.path,{format:!0})})}get(e){return s(this,null,function*(){return this.json[e]})}getAll(){return s(this,null,function*(){let e=[];return this.json&&(e=Object.keys(this.json).map(r=>({key:r,value:this.json[r]}))),e})}remove(e){return s(this,null,function*(){delete this.json[e],P(this.json,this.path,{format:!0})})}delete(){return s(this,null,function*(){this.json={},ve(this.path)})}},T=R;import m from"path";var _e=(f(),v(p)),{write_json:Ee,read_json:B,delete_json:D,mkdir:Se,ls_files:H,rm_dir:xe}=_e,k=class extends h{constructor(){super(),this.path=""}open(i){return s(this,arguments,function*({name:e,path:r}){r=m.join(r,e),Se(r),this.path=r})}set(e,r){return s(this,null,function*(){if(typeof e=="number"&&(e=this._convet_to_string_int(e)),typeof r!="object")throw new Error("value must be a js object");return Ee(r,m.join(this.path,e+".json"),{format:!0})})}get(e){return s(this,null,function*(){return typeof e=="number"&&(e=this._convet_to_string_int(e)),B(m.join(this.path,e+".json"))})}getAll(){return s(this,null,function*(){let e=H(this.path),r=[];for(let i of e)r.push({key:m.basename(i,".json"),value:B(m.join(this.path,i))});return r})}remove(e){return s(this,null,function*(){return typeof e=="number"&&(e=this._convet_to_string_int(e)),D(m.join(this.path,e+".json"))})}delete(){return s(this,null,function*(){let e=H(this.path);for(let r=0;r<e.length;r++)D(e[0]);xe(this.path)})}_convet_to_string_int(e){let r=10,i=e.toString(),n=i.length;return"0".repeat(r-n)+i}},F=k;import{MongoClient as je}from"mongodb";var M=class extends h{constructor({url:e,database:r}){super(),this.url=e,this.client=new je(e),this.database=r,this.collection=void 0}open(r){return s(this,arguments,function*({name:e}){this.collection=e,yield this.client.connect(),this.database=this.client.db(this.database),this.collection=this.database.collection(this.collection)})}set(e,r){return s(this,null,function*(){return yield this.collection.insertOne(r)})}get(e){return s(this,null,function*(){return yield this.collection.find(e).toArray()})}getAll(){return s(this,null,function*(){return yield this.collection.find({}).toArray()})}remove(e){return s(this,null,function*(){return yield this.collection.deleteMany(e)})}delete(){return s(this,null,function*(){return yield this.collection.drop(),yield this.client.close()})}},A=M;import Pe from"sqlite3";import{open as Re}from"sqlite";var Te=(f(),v(p)),{rm_file:ke}=Te,O=class extends h{constructor(){super(),this.file=void 0,this.db=void 0}open(r){return s(this,arguments,function*({name:t,path:e}){this.file=e+"/"+t+".sqlite",this.db=yield Re({filename:this.file,driver:Pe.Database});try{yield this.db.exec("CREATE TABLE storage ( key TEXT PRIMARY KEY, value TEXT, type TEXT)")}catch(i){if(i.code!=="SQLITE_ERROR")throw i}})}set(t,e){return s(this,null,function*(){let[r,i]=this._parseValue(e),n;try{n=yield this.db.get(`SELECT value FROM storage WHERE key = '${t}'`)}catch(o){if(o.code!=="SQLITE_ERROR")throw o;n=void 0}n?yield this.db.exec(`UPDATE storage SET value = '${r}', type = '${i}' WHERE key = '${t}'`):yield this.db.exec(`INSERT INTO storage (key, value, type) VALUES ( '${t}', '${r}', '${i}')`)})}get(t){return s(this,null,function*(){let e;try{e=yield this.db.get(`SELECT value, type FROM storage WHERE key = '${t}'`)}catch(r){if(r.code!=="SQLITE_ERROR")throw r;e=void 0}if(e&&e.value!=="undefined")return this._parseString(e.value,e.type)})}getAll(){return s(this,null,function*(){let t=yield this.db.all("SELECT key, value, type FROM storage");return t.length===0?[]:t.map(r=>({key:r.key,value:this._parseString(r.value,r.type)}))})}remove(t){return s(this,null,function*(){let e;try{e=yield this.db.get(`SELECT value FROM storage WHERE key = '${t}'`)}catch(r){if(r.code!=="SQLITE_ERROR")throw r;e=void 0}e&&(yield this.db.exec(`DELETE FROM storage WHERE key = '${t}'`))})}delete(){return s(this,null,function*(){yield this.db.exec("DELETE FROM storage"),ke(this.file)})}_parseValue(t){if(typeof t=="object")return[JSON.stringify(t),"object"];if(typeof t=="string")return[t,"string"];if(typeof t=="number")return[t.toString(),"number"];if(typeof t=="function")return[t.toString(),"function"];if(typeof t=="boolean")return[t.toString(),"boolean"];if(typeof t=="undefined")return["undefined","undefined"];throw new Error("Invalid value type")}_parseString(value,type){if(type==="object")return JSON.parse(value);if(type==="string")return value;if(type==="number")return Number(value);if(type==="function")return eval(value);if(type==="boolean")return!!value;if(type==="undefined")return}},q=O;var $=class{constructor({type:e,path:r,keyValue:i,mutex:n,url:o,database:a}){this.type=e,this.path=r,this.keyValue=i!=null?i:!1,this.mutex=n!=null?n:!0,this.url=o!=null?o:"",this.database=a!=null?a:""}open(e){return s(this,null,function*(){let r=new L({type:this.type,path:this.path,keyValue:this.keyValue,mutex:this.mutex,url:this.url,database:this.database});return yield r.open(e),r})}},L=class{constructor({type:e,path:r,keyValue:i,mutex:n,url:o,database:a}){this.add=this.set;this.push=this.set;this.write=this.set;this.read=this.get;this.all=this.getAll;this.list=this.getAll;if(console.log("input path:",r),r){let{dir:u,name:c}=I(r);if(c==="file")throw new Error("path must be a directory");this.path=u,console.log("dir:",u)}else this.path=Fe.join(process.cwd(),"storage");if(console.log("this.path:",this.path),W.existsSync(this.path)||W.mkdirSync(this.path),this.keyValue=i!=null?i:!1,this.mutex=n===!1?null:new Me,e==="json")this.storage=new F;else if(e==="jsonFile")this.storage=new T;else if(e==="cvs")this.storage=new x;else if(e==="sqlite")this.storage=new q;else if(e==="binary")this.storage=new E;else if(e==="mongodb"){if(!o||!a)throw new Error("url and database must be defined");this.mutex=null,this.keyValue=!1,this.storage=new A({url:o,database:a})}else throw new Error(`type ${e} is not supported`);this.index=this.keyValue?-1:0}open(e){return s(this,null,function*(){yield this.storage.open({name:e,path:this.path})})}set(e,r){return s(this,null,function*(){let{key:i,value:n}=this._handleInputs(e,r);return yield this._mutex(()=>s(this,null,function*(){return yield this.storage.set(i,n)}))})}get(e){return s(this,null,function*(){return yield this._mutex(()=>s(this,null,function*(){return yield this.storage.get(e)}))})}getAll(){return s(this,null,function*(){return yield this._mutex(()=>s(this,null,function*(){return yield this.storage.getAll()}))})}has(e){return s(this,null,function*(){return yield this._mutex(()=>s(this,null,function*(){return!!(yield yield this.storage.get(e))}))})}remove(e){return s(this,null,function*(){return yield this._mutex(()=>s(this,null,function*(){return yield this.storage.remove(e)}))})}delete(){return s(this,null,function*(){return yield this._mutex(()=>s(this,null,function*(){return yield this.storage.delete()}))})}_handleInputs(e,r){let i,n;return this.keyValue?(i=e,n=r):(i=++this.index,n=e),{key:i,value:n}}_mutex(e){return this.mutex?this.mutex.runExclusive(e):e()}},Q=$;var kt=Q;export{kt as default};
