"use strict";var ee=Object.create;var y=Object.defineProperty;var te=Object.getOwnPropertyDescriptor;var re=Object.getOwnPropertyNames;var ie=Object.getPrototypeOf,ne=Object.prototype.hasOwnProperty;var se=(i,e)=>{for(var t in e)y(i,t,{get:e[t],enumerable:!0})},D=(i,e,t,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of re(e))!ne.call(i,s)&&s!==t&&y(i,s,{get:()=>e[s],enumerable:!(n=te(e,s))||n.enumerable});return i};var c=(i,e,t)=>(t=i!=null?ee(ie(i)):{},D(e||!i||!i.__esModule?y(t,"default",{value:i,enumerable:!0}):t,i)),ae=i=>D(y({},"__esModule",{value:!0}),i);var r=(i,e,t)=>new Promise((n,s)=>{var a=u=>{try{h(t.next(u))}catch(m){s(m)}},l=u=>{try{h(t.throw(u))}catch(m){s(m)}},h=u=>u.done?n(u.value):Promise.resolve(u.value).then(a,l);h((t=t.apply(i,e)).next())});var fe={};se(fe,{default:()=>ue});module.exports=ae(fe);var I=c(require("fs"),1),K=c(require("path"),1);var q=c(require("path"),1),oe=i=>{let e=q.default.parse(i);if(e.name===i)throw new Error(`${i} path could not be parsed`);return e},V=oe;var z=require("async-mutex");var b=class{open(n){return r(this,arguments,function*({name:e,path:t}){throw new Error("Method not implemented.")})}set(e,t){return r(this,null,function*(){throw new Error("Method not implemented.")})}get(e){return r(this,null,function*(){throw new Error("Method not implemented.")})}getAll(){return r(this,null,function*(){throw new Error("Method not implemented.")})}remove(e){return r(this,null,function*(){throw new Error("Method not implemented.")})}delete(){return r(this,null,function*(){throw new Error("Method not implemented.")})}},f=b;var v=class extends f{open(n){return r(this,arguments,function*({name:e,path:t}){})}set(e,t){return r(this,null,function*(){})}get(e){return r(this,null,function*(){})}getAll(){return r(this,null,function*(){})}remove(e){return r(this,null,function*(){})}delete(){return r(this,null,function*(){})}},E=v;var S=class{open(n){return r(this,arguments,function*({name:e,path:t}){})}set(e,t){return r(this,null,function*(){})}get(e){return r(this,null,function*(){})}getAll(){return r(this,null,function*(){})}remove(e){return r(this,null,function*(){})}delete(){return r(this,null,function*(){})}},P=S;var W=c(require("path"),1),d=require("files-js");var k=class extends f{constructor(){super(),this.json={},this.path=""}open(n){return r(this,arguments,function*({name:e,path:t}){this.path=W.default.join(t,`${e}.json`),this.json={},(0,d.read_json)(this.path)?this.json=(0,d.read_json)(this.path):(0,d.write_json)(this.json,this.path,{format:!0})})}set(e,t){return r(this,null,function*(){this.json[e]=t,(0,d.write_json)(this.json,this.path,{format:!0})})}get(e){return r(this,null,function*(){return this.json[e]})}getAll(){return r(this,null,function*(){let e=[];return this.json&&(e=Object.keys(this.json).map(t=>({key:t,value:this.json[t]}))),e})}remove(e){return r(this,null,function*(){delete this.json[e],(0,d.write_json)(this.json,this.path,{format:!0})})}delete(){return r(this,null,function*(){this.json={},(0,d.delete_json)(this.path)})}},x=k;var p=c(require("path"),1),o=require("files-js");var _=class extends f{constructor(){super(),this.path=""}open(n){return r(this,arguments,function*({name:e,path:t}){t=p.default.join(t,e),(0,o.mkdir)(t),this.path=t})}set(e,t){return r(this,null,function*(){if(typeof e=="number"&&(e=this._convet_to_string_int(e)),typeof t!="object")throw new Error("value must be a js object");return(0,o.write_json)(t,p.default.join(this.path,e+".json"),{format:!0})})}get(e){return r(this,null,function*(){return typeof e=="number"&&(e=this._convet_to_string_int(e)),(0,o.read_json)(p.default.join(this.path,e+".json"))})}getAll(){return r(this,null,function*(){let e=(0,o.ls_files)(this.path),t=[];for(let n of e)t.push({key:p.default.basename(n,".json"),value:(0,o.read_json)(p.default.join(this.path,n))});return t})}remove(e){return r(this,null,function*(){return typeof e=="number"&&(e=this._convet_to_string_int(e)),(0,o.delete_json)(p.default.join(this.path,e+".json"))})}delete(){return r(this,null,function*(){let e=(0,o.ls_files)(this.path);for(let t=0;t<e.length;t++)(0,o.delete_json)(e[0]);(0,o.rm_dir)(this.path)})}_convet_to_string_int(e){let t=10,n=e.toString(),s=n.length;return"0".repeat(t-s)+n}},j=_;var J=c(require("sqlite3"),1),N=require("sqlite"),H=require("files-js");var R=class extends f{constructor(){super(),this.file=void 0,this.db=void 0}open(t){return r(this,arguments,function*({name:i,path:e}){this.file=e+"/"+i+".sqlite",this.db=yield(0,N.open)({filename:this.file,driver:J.default.Database});try{yield this.db.exec("CREATE TABLE storage ( key TEXT PRIMARY KEY, value TEXT, type TEXT)")}catch(n){if(n.code!=="SQLITE_ERROR")throw n}})}set(i,e){return r(this,null,function*(){let[t,n]=this._parseValue(e),s;try{s=yield this.db.get(`SELECT value FROM storage WHERE key = '${i}'`)}catch(a){if(a.code!=="SQLITE_ERROR")throw a;s=void 0}s?yield this.db.exec(`UPDATE storage SET value = '${t}', type = '${n}' WHERE key = '${i}'`):yield this.db.exec(`INSERT INTO storage (key, value, type) VALUES ( '${i}', '${t}', '${n}')`)})}get(i){return r(this,null,function*(){let e;try{e=yield this.db.get(`SELECT value, type FROM storage WHERE key = '${i}'`)}catch(t){if(t.code!=="SQLITE_ERROR")throw t;e=void 0}if(e&&e.value!=="undefined")return this._parseString(e.value,e.type)})}getAll(){return r(this,null,function*(){let i=yield this.db.all("SELECT key, value, type FROM storage");return i.length===0?[]:i.map(t=>({key:t.key,value:this._parseString(t.value,t.type)}))})}remove(i){return r(this,null,function*(){let e;try{e=yield this.db.get(`SELECT value FROM storage WHERE key = '${i}'`)}catch(t){if(t.code!=="SQLITE_ERROR")throw t;e=void 0}e&&(yield this.db.exec(`DELETE FROM storage WHERE key = '${i}'`))})}delete(){return r(this,null,function*(){yield this.db.exec("DELETE FROM storage"),(0,H.rm_file)(this.file)})}_parseValue(i){if(typeof i=="object")return[JSON.stringify(i),"object"];if(typeof i=="string")return[i,"string"];if(typeof i=="number")return[i.toString(),"number"];if(typeof i=="function")return[i.toString(),"function"];if(typeof i=="boolean")return[i.toString(),"boolean"];if(typeof i=="undefined")return["undefined","undefined"];throw new Error("Invalid value type")}_parseString(value,type){if(type==="object")return JSON.parse(value);if(type==="string")return value;if(type==="number")return Number(value);if(type==="function")return eval(value);if(type==="boolean")return!!value;if(type==="undefined")return}},T=R;var G=require("mongodb");var M=class extends f{constructor({url:e,database:t}){super(),this.url=e,this.client=new G.MongoClient(e),this.database=t,this.collection=void 0}open(t){return r(this,arguments,function*({name:e}){this.collection=e,yield this.client.connect(),this.database=this.client.db(this.database),this.collection=this.database.collection(this.collection)})}set(e,t){return r(this,null,function*(){return yield this.collection.insertOne(t)})}get(e){return r(this,null,function*(){return yield this.collection.find(e).toArray()})}getAll(){return r(this,null,function*(){return yield this.collection.find({}).toArray()})}remove(e){return r(this,null,function*(){return yield this.collection.deleteMany(e)})}delete(){return r(this,null,function*(){return yield this.collection.drop(),yield this.client.close()})}},A=M;var w=require("mongodb"),U=require("stream");var g=c(require("fs"),1);function le(i){if(!g.default.existsSync(i))throw new Error("File not found");if(g.default.lstatSync(i).isDirectory())throw new Error("Path is a directory");return g.default.createReadStream(i)}var B=le;var Q=require("stream");function he(i){return new Q.Readable({read(){this.push(i),this.push(null)}})}var F=he;var X=c(require("stream-to-array"),1);var O=class extends f{constructor({url:e,database:t}){super(),this.url=e,this.client=new w.MongoClient(e),this.database=t,this.bucket=void 0,this.filesCollection="files",this.chunksCollection="chunks"}open(t){return r(this,arguments,function*({name:e}){let n=e!=null?e:"files";this.filesCollection=n+".files",this.chunksCollection=n+".chunks",yield this.client.connect(),this.database=this.client.db(this.database),this.bucket=new w.GridFSBucket(this.database,{bucketName:n})})}set(e,t){return r(this,null,function*(){if(!t.filename)throw new Error("filename is required in metadata");if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");return new Promise((n,s)=>{let a=t.filename,l=this._handleFileInput(e),h=this.bucket.openUploadStream(a,t);h.on("finish",()=>n(!0)),h.on("error",u=>s(u)),l.pipe(h,{end:!0})})})}get(e){return r(this,null,function*(){if(!e.filename)throw new Error("Filename is required in metadata");if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");let t=yield this.bucket.find(e).toArray();return t.length===0?[]:yield Promise.all(t.map(n=>this._get(n)))})}_get(e){return r(this,null,function*(){return yield new Promise((t,n)=>r(this,null,function*(){let s=e._id,a=this.bucket.openDownloadStream(s);a.on("error",h=>n(h));let l=yield(0,X.default)(a).then(function(h){let u=h.map(m=>m instanceof Buffer?m:Buffer.from(m));return Buffer.concat(u)});t({buffer:l,metadata:e})}))})}getAll(){return r(this,null,function*(){if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");return(yield this.bucket.find().toArray()).map(t=>t.filename)})}remove(e){return r(this,null,function*(){if(!e.filename)throw new Error("filename is required in metadata");if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");let t=yield this.bucket.find(e).toArray();return!(t.length===0||(yield Promise.all(t.map(s=>this._remove(s)))).includes(!1))})}_remove(e){return r(this,null,function*(){let t=e._id;return yield this.bucket.delete(t),!0})}close(){return r(this,null,function*(){if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");this.bucket=void 0,yield this.client.close()})}delete(){return r(this,null,function*(){if(this.bucket===void 0)throw new Error("Bucket is not defined, call open() first");yield this.bucket.drop(),yield this.client.close()})}_handleFileInput(e){if(e instanceof Buffer)return F(e);if(typeof e=="string")return B(e);if(e instanceof U.Readable)return e;throw new Error("Invalid input, expected a Buffer,  ReadableStream, or path to a file.")}},Y=O;var C=Y;var $=class{constructor({type:e,path:t,keyValue:n,mutex:s,url:a,database:l}){this.type=e,this.path=t,this.keyValue=n!=null?n:!1,this.mutex=s!=null?s:!0,this.url=a!=null?a:"",this.database=l!=null?l:""}open(e){return r(this,null,function*(){let t=new L({type:this.type,path:this.path,keyValue:this.keyValue,mutex:this.mutex,url:this.url,database:this.database});return yield t.open(e),t})}},L=class{constructor({type:e,path:t,keyValue:n,mutex:s,url:a,database:l}){this.add=this.set;this.push=this.set;this.write=this.set;this.read=this.get;this.all=this.getAll;this.list=this.getAll;if(t){let{dir:h,name:u}=V(t);if(u==="file")throw new Error("path must be a directory");this.path=h}else this.path=K.default.join(process.cwd(),"storage");if(I.default.existsSync(this.path)||I.default.mkdirSync(this.path),this.keyValue=n!=null?n:!1,this.mutex=s===!1?null:new z.Mutex,e==="json")this.storage=new j;else if(e==="jsonFile")this.storage=new x;else if(e==="cvs")this.storage=new P;else if(e==="sqlite")this.storage=new T;else if(e==="binary")this.storage=new E;else if(e==="mongodb"){if(!a||!l)throw new Error("url and database must be defined");this.mutex=null,this.keyValue=!1,this.storage=new A({url:a,database:l})}else if(e==="mongoFiles"){if(!a||!l)throw new Error("url and database must be defined");this.mutex=null,this.keyValue=!0,this.storage=new C({url:a,database:l})}else throw new Error(`type ${e} is not supported`);this.index=this.keyValue?-1:0}open(e){return r(this,null,function*(){yield this.storage.open({name:e,path:this.path})})}set(e,t){return r(this,null,function*(){let{key:n,value:s}=this._handleInputs(e,t);return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.set(n,s)}))})}get(e){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.get(e)}))})}getAll(){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.getAll()}))})}has(e){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return!!(yield yield this.storage.get(e))}))})}remove(e){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.remove(e)}))})}delete(){return r(this,null,function*(){return yield this._mutex(()=>r(this,null,function*(){return yield this.storage.delete()}))})}_handleInputs(e,t){let n,s;return this.keyValue?(n=e,s=t):(n=++this.index,s=e),{key:n,value:s}}_mutex(e){return this.mutex?this.mutex.runExclusive(e):e()}},Z=$;var ue=Z;
